<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI P&L Generator | Laporan Laba Rugi</title>
    <!-- Memuat Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        /* Menggunakan font Inter untuk tampilan modern */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7fafc;
            /* Latar belakang sangat terang */
        }

        /* Style untuk menampung laporan yang dihasilkan agar terlihat bagus */
        #reportOutput {
            min-height: 200px;
            padding: 1.5rem;
            background-color: #ffffff;
            border: 1px solid #e2e8f0;
        }

        /* Kustomisasi scrollbar untuk tampilan yang lebih halus */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-thumb {
            background-color: #cbd5e1;
            border-radius: 4px;
        }
    </style>
</head>

<body class="p-4 md:p-8">

    <div class="max-w-4xl mx-auto">
        <header class="text-center mb-8">
            <h1 class="text-3xl font-extrabold text-gray-800">Pembuat Laporan Laba Rugi AI</h1>
            <p class="text-gray-500 mt-2">Masukkan data keuangan dan biarkan AI menghasilkan laporan yang sudah distyle.
            </p>
        </header>

        <div class="bg-white p-6 rounded-xl shadow-2xl mb-8">
            <h2 class="text-xl font-semibold mb-4 text-indigo-700">Data Umum</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                <!-- Nama Perusahaan -->
                <div>
                    <label for="perusahaan" class="block text-sm font-medium text-gray-700 mb-1">Nama Perusahaan</label>
                    <input type="text" id="perusahaan" value="PT. Solusi Digital Abadi"
                        class="w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500"
                        placeholder="Masukkan nama perusahaan">
                </div>
                <!-- Periode Laporan -->
                <div>
                    <label for="periode" class="block text-sm font-medium text-gray-700 mb-1">Periode Laporan</label>
                    <input type="text" id="periode" value="31 Desember 2023"
                        class="w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500"
                        placeholder="Contoh: 1 Jan - 31 Des 2023">
                </div>
            </div>

            <h2 class="text-xl font-semibold mb-4 text-indigo-700 flex justify-between items-center border-t pt-4">
                Data Transaksi
                <button id="addRowBtn"
                    class="bg-green-500 hover:bg-green-600 text-white p-2 rounded-full shadow-md text-sm transition duration-150">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd"
                            d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z"
                            clip-rule="evenodd" />
                    </svg>
                </button>
            </h2>

            <!-- Tabel Input Transaksi -->
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Kategori</th>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Keterangan</th>
                            <th class="px-3 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Jumlah (Rp)</th>
                            <th class="px-3 py-3 text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="transactionTableBody" class="bg-white divide-y divide-gray-200">
                        <!-- Baris input akan di-inject di sini -->
                    </tbody>
                </table>
            </div>

            <button id="generateBtn"
                class="mt-6 w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg shadow-xl transition duration-300 ease-in-out transform hover:scale-[1.01] flex items-center justify-center"
                disabled>
                <span id="btnText">Buat Laporan</span>
                <svg id="loadingSpinner" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden"
                    xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor"
                        d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                    </path>
                </svg>
            </button>
            <div id="messageBox" class="mt-4 p-3 rounded-lg text-sm hidden"></div>
        </div>

        <!-- Output Laporan -->
        <div class="mt-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-4 border-b pb-2">Hasil Laporan Laba Rugi</h2>
            <!-- Kontainer untuk laporan yang dihasilkan AI -->
            <div id="reportOutput" class="rounded-xl shadow-inner overflow-hidden">
                <p class="text-center text-gray-400 py-10">Laporan yang dihasilkan akan muncul di sini.</p>
            </div>

            <div class="mt-4 flex justify-end">
                <button id="downloadPDF"
                    class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition">
                    Download PDF
                </button>
            </div>
        </div>

    </div>

    <script>
        const tableBody = document.getElementById('transactionTableBody');
        const addRowBtn = document.getElementById('addRowBtn');
        const generateBtn = document.getElementById('generateBtn');
        const reportOutput = document.getElementById('reportOutput');
        const messageBox = document.getElementById('messageBox');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const btnText = document.getElementById('btnText');
        const defaultRows = 4;
        let rowCount = 0;

        /**
         * Fungsi untuk menambahkan baris input transaksi baru.
         * @param {string} category - Nilai default kategori.
         * @param {string} description - Nilai default keterangan.
         * @param {string} amount - Nilai default jumlah.
         */
        function addTransactionRow(category = 'Pendapatan', description = '', amount = '') {
            const row = tableBody.insertRow();
            row.id = `row-${rowCount}`;
            row.classList.add('hover:bg-gray-100', 'transition', 'duration-150');

            row.innerHTML = `
                <td class="p-2">
                    <select class="w-full p-2 border border-gray-200 rounded-lg text-sm" name="kategori">
                        <option value="Pendapatan" ${category === 'Pendapatan' ? 'selected' : ''}>Pendapatan</option>
                        <option value="Beban" ${category === 'Beban' ? 'selected' : ''}>Beban</option>
                    </select>
                </td>
                <td class="p-2">
                    <input type="text" value="${description}" class="w-full p-2 border border-gray-200 rounded-lg text-sm" name="keterangan" placeholder="Keterangan transaksi...">
                </td>
                <td class="p-2">
                    <input type="number" value="${amount}" class="w-full p-2 border border-gray-200 rounded-lg text-sm text-right" name="jumlah" placeholder="Contoh: 1000000" min="0">
                </td>
                <td class="p-2 text-center">
                    <button type="button" data-row-id="${rowCount}" class="removeRowBtn text-red-500 hover:text-red-700 transition duration-150 p-1 rounded-full hover:bg-red-100">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                        </svg>
                    </button>
                </td>
            `;

            // Tambahkan event listener untuk tombol hapus
            row.querySelector('.removeRowBtn').addEventListener('click', (e) => {
                row.remove();
                checkIfReadyToGenerate();
            });

            // Tambahkan event listener untuk input agar selalu memeriksa tombol generate
            row.querySelectorAll('input, select').forEach(input => {
                input.addEventListener('input', checkIfReadyToGenerate);
            });

            rowCount++;
            checkIfReadyToGenerate();
        }

        /**
         * Mengisi baris default dan data contoh.
         */
        function initializeDefaultRows() {
            // Data contoh
            const sampleData = [
                { cat: 'Pendapatan', desc: 'Penjualan Jasa', amount: '50000000' },
                { cat: 'Pendapatan', desc: 'Pendapatan Bunga', amount: '500000' },
                { cat: 'Beban', desc: 'Gaji Karyawan', amount: '15000000' },
                { cat: 'Beban', desc: 'Biaya Sewa Kantor', amount: '6000000' },
            ];

            sampleData.forEach(data => addTransactionRow(data.cat, data.desc, data.amount));

            // Tambahkan beberapa baris kosong untuk input tambahan
            for (let i = sampleData.length; i < defaultRows; i++) {
                addTransactionRow();
            }
        }

        /**
         * Memeriksa apakah minimal ada satu baris transaksi yang valid (keterangan & jumlah terisi)
         * untuk mengaktifkan tombol generate.
         */
        function checkIfReadyToGenerate() {
            const keteranganInputs = Array.from(document.querySelectorAll('[name="keterangan"]')).map(el => el.value.trim());
            const jumlahInputs = Array.from(document.querySelectorAll('[name="jumlah"]')).map(el => el.value.trim());

            let hasValidData = false;
            for (let i = 0; i < keteranganInputs.length; i++) {
                // Baris dianggap valid jika keterangan terisi DAN jumlah adalah angka yang valid dan tidak nol
                if (keteranganInputs[i] && jumlahInputs[i] && !isNaN(parseFloat(jumlahInputs[i])) && parseFloat(jumlahInputs[i]) !== 0) {
                    hasValidData = true;
                    break;
                }
            }

            // Juga periksa apakah Nama Perusahaan dan Periode terisi
            const perusahaanFilled = document.getElementById('perusahaan').value.trim() !== "";
            const periodeFilled = document.getElementById('periode').value.trim() !== "";

            if (hasValidData && perusahaanFilled && periodeFilled) {
                generateBtn.disabled = false;
                generateBtn.classList.remove('bg-indigo-400', 'cursor-not-allowed');
                generateBtn.classList.add('bg-indigo-600', 'hover:bg-indigo-700');
            } else {
                generateBtn.disabled = true;
                generateBtn.classList.remove('bg-indigo-600', 'hover:bg-indigo-700');
                generateBtn.classList.add('bg-indigo-400', 'cursor-not-allowed');
            }
        }

        /**
         * Mengambil data dari form dan memformatnya menjadi JSON untuk dikirim ke backend.
         */
        function collectData() {
            const data = {
                perusahaan: document.getElementById('perusahaan').value,
                periode: document.getElementById('periode').value,
                kategori: [],
                keterangan: [],
                jumlah: []
            };

            const rows = tableBody.querySelectorAll('tr');
            rows.forEach(row => {
                const category = row.querySelector('[name="kategori"]').value.trim();
                const description = row.querySelector('[name="keterangan"]').value.trim();
                const amount = row.querySelector('[name="jumlah"]').value.trim();

                // Hanya kirim baris yang memiliki keterangan DAN jumlah yang valid
                if (description && amount && !isNaN(parseFloat(amount)) && parseFloat(amount) !== 0) {
                    data.kategori.push(category);
                    data.keterangan.push(description);
                    data.jumlah.push(amount);
                }
            });

            return data;
        }

        /**
         * Menampilkan pesan notifikasi (sukses/error).
         * @param {string} message - Pesan yang akan ditampilkan.
         * @param {string} type - 'success' atau 'error'.
         */
        function showMessage(message, type) {
            messageBox.textContent = message;
            messageBox.classList.remove('hidden', 'bg-red-100', 'text-red-700', 'bg-green-100', 'text-green-700');
            if (type === 'error') {
                messageBox.classList.add('bg-red-100', 'text-red-700');
            } else if (type === 'success') {
                messageBox.classList.add('bg-green-100', 'text-green-700');
            }
            setTimeout(() => {
                messageBox.classList.add('hidden');
            }, 5000);
        }

        /**
         * Handler utama untuk proses pembuatan laporan.
         */
        async function handleGenerateReport() {
            const data = collectData();

            // Tampilkan loading state
            generateBtn.disabled = true;
            loadingSpinner.classList.remove('hidden');
            btnText.textContent = 'Membuat Laporan...';
            reportOutput.innerHTML = '<p class="text-center text-indigo-500 py-10 animate-pulse">AI sedang menganalisis data dan menyusun laporan...</p>';
            messageBox.classList.add('hidden');

            try {
                const response = await fetch('/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (response.ok) {
                    // Berhasil: masukkan fragmen HTML yang distyle ke output
                    reportOutput.innerHTML = result.html_report;
                    showMessage("Laporan berhasil dibuat! Lihat hasilnya di bawah.", 'success');

                    requestAnimationFrame(() => {
                        const element = document.getElementById("reportOutput");

                        // Sedikit delay tambahan untuk font & style
                        setTimeout(() => {
                            html2pdf()
                                .from(element)
                                .set({
                                    margin: 10,
                                    filename: 'laporan-laba-rugi.pdf',
                                    html2canvas: { scale: 2 }, // biar tajam
                                    jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
                                })
                                .save();
                        }, 300); // delay kecil aja cukup
                    });
                } else {
                    // Gagal: tampilkan pesan error dari backend
                    const errorMessage = result.error || "Terjadi kesalahan yang tidak diketahui saat membuat laporan.";
                    reportOutput.innerHTML = `<p class="text-center text-red-500 py-10 font-medium">Gagal Membuat Laporan:</p><p class="text-center text-red-400">${errorMessage}</p>`;
                    showMessage(`Error: ${errorMessage}`, 'error');
                }

            } catch (error) {
                // Gagal koneksi (network error, dll)
                console.error('Network or API Error:', error);
                reportOutput.innerHTML = '<p class="text-center text-red-500 py-10 font-medium">Kesalahan Jaringan. Pastikan backend Flask berjalan dengan benar.</p>';
                showMessage("Kesalahan Jaringan: Tidak dapat terhubung ke server.", 'error');
            } finally {
                // Sembunyikan loading state
                loadingSpinner.classList.add('hidden');
                btnText.textContent = 'Buat Laporan';
                checkIfReadyToGenerate(); // Periksa kembali apakah tombol harus diaktifkan
            }
        }

        // Event Listeners
        addRowBtn.addEventListener('click', () => addTransactionRow());
        generateBtn.addEventListener('click', handleGenerateReport);
        document.getElementById('perusahaan').addEventListener('input', checkIfReadyToGenerate);
        document.getElementById('periode').addEventListener('input', checkIfReadyToGenerate);

        // Inisialisasi
        initializeDefaultRows();
        checkIfReadyToGenerate(); // Panggil saat inisialisasi untuk mengaktifkan/menonaktifkan tombol

        document.getElementById("downloadPDF").addEventListener("click", () => {
            const element = document.getElementById("reportOutput");
            console.log(element)

            const opt = {
                margin: 0.5,
                filename: 'laporan-laba-rugi.pdf',
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2 },
                jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' }
            };

            if (element && element.innerHTML.trim() !== "") {
                html2pdf().from(element).save("laporan.pdf");
            } else {
                alert("Laporan belum digenerate!");
            }

        });
    </script>
</body>

</html>